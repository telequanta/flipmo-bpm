<script>
let audioContext, analyser, source;
let dataArray;
let peakTimes = [];
let bpmDisplay = document.getElementById('bpm');
let bpmTimer;
const PEAK_THRESHOLD = 5; // Lowered threshold for quieter peaks
const MIN_PEAK_INTERVAL = 0.35; // Accept faster beats (~170 BPM max)
const MAX_PEAK_INTERVAL = 0.75; // Accept slower beats (~80 BPM min)
const EXPECTED_BPM_RANGE = [100, 135];
let lastPeakTime = 0;

async function startMic() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  source = audioContext.createMediaStreamSource(stream);

  analyser = audioContext.createAnalyser();
  analyser.fftSize = 1024;
  dataArray = new Uint8Array(analyser.frequencyBinCount);

  source.connect(analyser);

  detectBeats();
  bpmTimer = setInterval(updateBPMDisplay, 2000);
}

function detectBeats() {
  analyser.getByteFrequencyData(dataArray); // Analyze frequency domain

  // Focus on midrange: bins 10–40 (~300Hz–800Hz range)
  let energy = 0;
  for (let i = 10; i < 40; i++) {
    energy += dataArray[i];
  }

  const currentTime = audioContext.currentTime;

  if (energy > PEAK_THRESHOLD) {
    let interval = currentTime - lastPeakTime;

    if (interval > MIN_PEAK_INTERVAL && interval < MAX_PEAK_INTERVAL) {
      peakTimes.push(currentTime);
      lastPeakTime = currentTime;

      // Keep only the last 40 beats
      if (peakTimes.length > 40) {
        peakTimes.shift();
      }
    }
  }

  requestAnimationFrame(detectBeats);
}

function updateBPMDisplay() {
  if (peakTimes.length < 4) {
    bpmDisplay.textContent = "-- BPM";
    return;
  }

  let intervals = [];
  for (let i = 1; i < peakTimes.length; i++) {
    intervals.push(peakTimes[i] - peakTimes[i - 1]);
  }

  const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
  let bpm = 60 / avgInterval;

  if (bpm >= EXPECTED_BPM_RANGE[0] && bpm <= EXPECTED_BPM_RANGE[1]) {
    bpmDisplay.textContent = bpm.toFixed(1) + " BPM";
  } else {
    bpmDisplay.textContent = "-- BPM";
  }
}

function resetBPM() {
  peakTimes = [];
  bpmDisplay.textContent = "-- BPM";
  clearInterval(bpmTimer);
}
</script>
